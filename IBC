import { useState } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { TooltipProvider, Tooltip, TooltipTrigger, TooltipContent } from "@/components/ui/tooltip";
import { Info } from "lucide-react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip as RechartsTooltip,
  ResponsiveContainer,
  ReferenceLine,
} from "recharts";

export default function InteroperabilityCalculator() {
  // helpers
  const pct = (x: number) => (isNaN(x) ? 0 : x) / 100;
  const num = (v: string) => Number(v || 0);
  const money = (v: number) => "$" + (isFinite(v) ? Math.round(v).toLocaleString() : "0");

  // Organisation-level inputs
  const [annualTests, setAnnualTests] = useState(205000);
  const [annualDischarges, setAnnualDischarges] = useState(90000);
  const [duplicateTestRate, setDuplicateTestRate] = useState(25);
  const [readmitRate, setReadmitRate] = useState(25);
  const [clinicians, setClinicians] = useState(100);
  const [visitsPerClinician, setVisitsPerClinician] = useState(2000);
  const [timeSavedPerVisitMin, setTimeSavedPerVisitMin] = useState(5);
  const [clinicianWagePerHour, setClinicianWagePerHour] = useState(95);

  // Implementation cost tier
  const [hospitalSize, setHospitalSize] = useState("medium");
  const getImplementationCost = (size: string) => {
    switch (size) {
      case "small":
        return 800000;
      case "medium":
        return 1500000;
      case "large":
        return 3000000;
      default:
        return 1500000;
    }
  };
  const investmentNZD = getImplementationCost(hospitalSize);

  // Evidence-backed assumptions
  const [testUnitCostNZD, setTestUnitCostNZD] = useState(50);
  const [readmitCostNZD, setReadmitCostNZD] = useState(3643);
  const [duplicateReductionPct, setDuplicateReductionPct] = useState(25) // default 25% based on AJMC 2015 HIE study;
  const [readmitReductionPct, setReadmitReductionPct] = useState(10);
  const [preventableReadmitPct, setPreventableReadmitPct] = useState(30);

  // Calculations
  const clinicianCostPerMinute = clinicianWagePerHour / 60;
  const timeSavedTotalMinutes = clinicians * visitsPerClinician * timeSavedPerVisitMin;
  const productivityGain = Math.round(timeSavedTotalMinutes * clinicianCostPerMinute);

  const testSavings = Math.round(
    annualTests * pct(duplicateTestRate) * pct(duplicateReductionPct) * testUnitCostNZD
  );
  const readmitSavings = Math.round(
    annualDischarges * pct(readmitRate) * pct(readmitReductionPct) * pct(preventableReadmitPct) * readmitCostNZD
  );

  const totalAnnualSavings = productivityGain + testSavings + readmitSavings;
  const netAnnualBenefit = totalAnnualSavings - investmentNZD;
  const roi = investmentNZD > 0 ? (totalAnnualSavings / investmentNZD).toFixed(2) : "0.00";

  const barData = [
    { name: "Gross Savings", value: totalAnnualSavings },
    { name: "Net Benefit (after Interoperability Standards cost)", value: netAnnualBenefit },
  ];
  const yValues = barData.map((d) => d.value);
  const yMin = Math.min(0, ...yValues);
  const yMax = Math.max(...yValues);

  // Dev sanity checks (acts as lightweight tests in the absence of a test runner)
  if (typeof window !== "undefined") {
    const _calc = (disch: number, rRatePct: number, rRedPct: number, prevPct: number, rCost: number) =>
      Math.round(disch * pct(rRatePct) * pct(rRedPct) * pct(prevPct) * rCost);
    console.assert(_calc(10000, 10, 10, 30, 3643) === Math.round(10000 * 0.1 * 0.1 * 0.3 * 3643), "Readmit calc sanity check");
    console.assert(productivityGain >= 0 && testSavings >= 0 && isFinite(netAnnualBenefit), "Outputs should be finite and non-negative (except Net may be negative)");
  }

  return (
    <TooltipProvider delayDuration={200}>
      <div className="min-h-screen bg-white text-slate-900 p-6 space-y-6">
        <h1 className="text-2xl font-bold">The Interoperability Benefits Calculator</h1>
        <p className="text-gray-700">
          Focus: Direct financial and productivity benefits to hospital on adopting
          Interoperability Standards in diagnostic services.
        </p>

        {/* Organisation Setup */}
        <Card>
          <CardHeader>
            <CardTitle>Organisation Setup</CardTitle>
          </CardHeader>
          <CardContent className="grid grid-cols-2 gap-4">
            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Annual diagnostic tests
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Annual diagnostic tests info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Default ~205,000 per year (Figure.NZ 2021).
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input type="number" value={annualTests} onChange={(e) => setAnnualTests(num(e.target.value))} />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Annual hospital discharges
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Annual hospital discharges info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Default ~90,000 per year (large metro hospital benchmark).
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={annualDischarges}
                onChange={(e) => setAnnualDischarges(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Duplicate test rate (%)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Duplicate test rate info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    % of tests that are unnecessary repeats. Used with reduction % to estimate avoided duplicates.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={duplicateTestRate}
                onChange={(e) => setDuplicateTestRate(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                30-day readmission rate (%)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Readmission rate info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    All-cause readmissions within 30 days of discharge. Default ~25%.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input type="number" value={readmitRate} onChange={(e) => setReadmitRate(num(e.target.value))} />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Number of clinicians
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Number of clinicians info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Doctors, nurses, pharmacists, and allied staff using the system.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input type="number" value={clinicians} onChange={(e) => setClinicians(num(e.target.value))} />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Visits per clinician per year
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Visits per clinician info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Average annual encounters per clinician. Drives total time-saved calculation.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={visitsPerClinician}
                onChange={(e) => setVisitsPerClinician(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Time saved per visit (minutes)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Time saved per visit info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Interoperability reduces admin time to find/share patient data. Start with 5–10 minutes.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={timeSavedPerVisitMin}
                onChange={(e) => setTimeSavedPerVisitMin(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Clinician cost per hour (NZD)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Clinician cost per hour info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Blended organisational hourly cost across the clinical workforce.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={clinicianWagePerHour}
                onChange={(e) => setClinicianWagePerHour(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Hospital size
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Hospital size info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Sets implementation cost: Small (≤10k) $800k; Medium (10k–90k) $1.5m; Large (≥90k) $3m.
                  </TooltipContent>
                </Tooltip>
              </label>
              <select
                className="border rounded-md p-2 w-full bg-white"
                value={hospitalSize}
                onChange={(e) => setHospitalSize(e.target.value)}
              >
                <option value="small">Small (≤10k discharges)</option>
                <option value="medium">Medium (10k–90k discharges)</option>
                <option value="large">Large (≥90k discharges)</option>
              </select>
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Test unit cost (NZD)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Test unit cost info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Average organisational cost per diagnostic test. Default $50.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={testUnitCostNZD}
                onChange={(e) => setTestUnitCostNZD(num(e.target.value))}
              />
            </div>
            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Readmission cost (NZD)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Readmission cost info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Median organisational cost per readmission in NZ. Default $3,643.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={readmitCostNZD}
                onChange={(e) => setReadmitCostNZD(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Reduction in duplicate tests (%)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Duplicate reduction info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Reduction in duplicate imaging by 25% (based on AJMC 2015 – Health Information Exchange and Repeat Imaging: https://www.ajmc.com/view/health-information-exchange-and-the-frequency-of-repeat-medical-imaging).
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={duplicateReductionPct}
                onChange={(e) => setDuplicateReductionPct(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Reduction in readmissions (%)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Readmission reduction info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Conservative default 10% (handover bundles often report higher).
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={readmitReductionPct}
                onChange={(e) => setReadmitReductionPct(num(e.target.value))}
              />
            </div>

            <div>
              <label className="flex items-center gap-2 text-sm font-medium">
                Proportion of readmissions preventable (%)
                <Tooltip>
                  <TooltipTrigger asChild>
                    <button
                      type="button"
                      aria-label="Preventable readmissions info"
                      className="cursor-help inline-flex items-center text-slate-500 hover:text-slate-700"
                    >
                      <Info size={16} />
                    </button>
                  </TooltipTrigger>
                  <TooltipContent side="top" className="max-w-xs text-xs">
                    Not all readmissions are avoidable. 30% is a conservative assumption.
                  </TooltipContent>
                </Tooltip>
              </label>
              <Input
                type="number"
                value={preventableReadmitPct}
                onChange={(e) => setPreventableReadmitPct(num(e.target.value))}
              />
            </div>
          </CardContent>
        </Card>

        {/* Results */}
        <Card>
          <CardHeader>
            <CardTitle>Results Dashboard (Organisation Lens)</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div className="grid grid-cols-3 gap-4 text-center">
              <div className="bg-blue-100 p-4 rounded-xl">
                <h2 className="text-lg font-semibold">Admin Time Savings</h2>
                <p className="text-xl font-bold">{money(productivityGain)} per year</p>
              </div>
              <div className="bg-green-100 p-4 rounded-xl">
                <h2 className="text-lg font-semibold">Test Savings</h2>
                <p className="text-xl font-bold">{money(testSavings)} per year</p>
              </div>
              <div className="bg-purple-100 p-4 rounded-xl">
                <h2 className="text-lg font-semibold">Readmission Savings</h2>
                <p className="text-xl font-bold">{money(readmitSavings)} per year</p>
              </div>
              <div className="bg-yellow-100 p-4 rounded-xl">
                <h2 className="text-lg font-semibold">ROI</h2>
                <p className="text-xl font-bold">{roi}x</p>
              </div>
            </div>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart
                data={barData}
                margin={{ top: 16, right: 16, bottom: 8, left: 16 }}
                barCategoryGap="35%"
              >
                <XAxis dataKey="name" />
                <YAxis domain={[yMin, yMax]} tickFormatter={(v) => "$" + Number(v).toLocaleString()} width={90} />
                <RechartsTooltip formatter={(value: any) => ["$" + Number(value).toLocaleString(), "Benefit"]} />
                <ReferenceLine y={0} stroke="#94a3b8" />
                <Bar dataKey="value" fill="#3b82f6" barSize={60} radius={[6, 6, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>

            <div className="text-center text-sm text-gray-600">
              *Net Benefit factors in Interoperability Standards investment of {money(investmentNZD)}.
            </div>
          </CardContent>
        </Card>

        {/* Evidence Section */}
        <Card>
          <CardHeader>
            <CardTitle>Evidence & Sources</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3 text-sm text-gray-700">
            <p>
              <strong>Admin Time Savings:</strong> clinicians × visits/year × minutes saved/visit × ($/hour ÷ 60).
              Evidence: Primary care doctors spend ~36 min/visit in EHR (
              <a
                href="https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2812258"
                target="_blank"
                className="text-blue-600 underline"
              >
                JAMA 2023
              </a>
              ).
            </p>
            <p>
              <strong>Test Savings:</strong> annual tests × (dup rate ÷ 100) × (reduction% ÷ 100) × test cost. Evidence:
              Health information exchange access reduced repeat imaging by ~25% (
              <a
                href="https://www.ajmc.com/view/health-information-exchange-and-the-frequency-of-repeat-medical-imaging"
                target="_blank"
                className="text-blue-600 underline"
              >
                AJMC 2015
              </a>
              ). NZ average hospital ~205,000 tests/year (
              <a
                href="https://figure.nz/chart/e3YmCq1YQJAx7tdA"
                target="_blank"
                className="text-blue-600 underline"
              >
                Figure.NZ 2021
              </a>
              ).
            </p>
            <p>
              <strong>Readmission Savings:</strong> annual discharges × (readmit rate ÷ 100) × (reduction% ÷ 100) × 30%
              preventable × $3,643. Evidence: AHRQ RED toolkit reports ~25% reduction in readmissions (
              <a
                href="https://www.ahrq.gov/patient-safety/settings/hospital/red/toolkit/index.html"
                target="_blank"
                className="text-blue-600 underline"
              >
                AHRQ
              </a>
              ). NZ health service use/readmission cost proxy ≈ $3,643 NZD (
              <a
                href="https://journal.nzma.org.nz/journal-articles/health-service-use-and-readmission-following-major-trauma-in-new-zealand"
                target="_blank"
                className="text-blue-600 underline"
              >
                NZMJ 2021
              </a>
              ).
            </p>
            <p>
              <strong>Clinician cost per hour (default = $95 NZD):</strong> Doctors: consultants ~NZ$185–268k/year →
              ≈$89–$129/hour (
              <a href="https://www.doctorpay.co.nz/" target="_blank" className="text-blue-600 underline">
                DoctorPay
              </a>
              ); GPs ≈$110.64/hour (
              <a
                href="https://transitionmedical.com/blog/what-do-gps-earn-in-new-zealand/"
                target="_blank"
                className="text-blue-600 underline"
              >
                Transition Medical
              </a>
              ); Nurses: RN ~NZ$35.14/hour (
              <a
                href="https://www.payscale.com/research/NZ/Job%3DRegistered_Nurse_%28RN%29/Hourly_Rate"
                target="_blank"
                className="text-blue-600 underline"
              >
                PayScale
              </a>
              ). Apply typical on‑costs ~25% (
              <a
                href="https://www.agoge.nz/files/theme/files/OncostsCalculationsClientInfoSheetOct2021.pdf"
                target="_blank"
                className="text-blue-600 underline"
              >
                Agoge
              </a>
              ) → blended ~NZ$85–$105/hour; default set to $95.
            </p>
            <p>
              <strong>Interoperability Standards investment:</strong> Small (≤10k discharges) $800k; Medium (10k–90k)
              $1.5m; Large (≥90k) $3m. Evidence: Global HIE implementations typically cost USD $400k–$2M (≈ NZD
              $660k–$3.3M) (
              <a
                href="https://www.scnsoft.com/healthcare/health-information-exchange-portal"
                target="_blank"
                className="text-blue-600 underline"
              >
                ScienceSoft
              </a>
              ).
            </p>
          </CardContent>
        </Card>
      </div>
    </TooltipProvider>
  );
}
